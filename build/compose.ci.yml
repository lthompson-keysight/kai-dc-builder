services:
  mock-dse:
    container_name: mock-dse
    image: alpine:latest
    command: sh -c "nc -l -k -p 443 & nc -l -k -p 50001 & nc -l -k -p 49999 & sleep infinity"
    expose:
      - "443"
      - "50001"
      - "49999"
    restart: always
    healthcheck:
      test:
        [
          "CMD-SHELL",
          'sh -c ''for port in 50001 49999 443; do echo "Checking $port"; nc -z localhost $port && echo "$port OK" || (echo "$port FAIL"; exit 1); done''',
        ]
      interval: 2s
      timeout: 3s
      retries: 15
      start_period: 10s
  ingress:
    container_name: ${INGRESS_NAME}
    hostname: ${INGRESS_NAME}
    image: ${INGRESS_DOCKER_IMAGE}
    command: |
      --app_port ${WEBUI} --routes "dse.DseService/mock-dse:50001,
      storage.StorageService/mock-dse:50001,
      storage_v2.ResultServiceAPI/mock-dse:49999,
      internal.UIService/mock-dse:50001,
      default/mock-dse:443"
    ports:
      - ${WEBUI}:${WEBUI}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      mock-dse:
        condition: service_healthy
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "timeout 2 sh -c '</dev/tcp/localhost/443' || exit 1"]
      interval: 2s
      timeout: 3s
      retries: 5
      start_period: 5s
